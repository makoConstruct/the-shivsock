//shiver.js. See https://github.com/makoConstruct/shiver.js for more info.
(function(){var defaultSock,_copy,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};this.shiverjs_version="1.0";this.actuallyInstanceOf=function(v,constructor){return v==null&&constructor==null||v.constructor===constructor||v instanceof constructor};this.intARGBColorToString=function(i){return"rgba("+(i>>16&255)+", "+(i>>8&255)+", "+(i&255)+", "+(i>>24&255)/255+")"};this.Storage.prototype.setObject=function(key,value){this.setItem(key,JSON.stringify(value))};this.Storage.prototype.getObject=function(key,defaultValue){var value;value=this.getItem(key);if(value){return JSON.parse(value)}else{return defaultValue}};this.indexOf=function(arr,el){var i;i=0;while(i<arr.length){if(arr[i]===el){return i}++i}return-1};this.timeoutSet=function(t,f){return setTimeout(f,t)};this.imul=Math.imul||function(a,b){var ah,al,bh,bl;ah=a>>>16&65535;al=a&65535;bh=b>>>16&65535;bl=b&65535;return al*bl+(ah*bl+al*bh<<16>>>0)|0};this.String.prototype.hashCode=function(){var ch,hash,i;hash=0;if(this.length===0){return hash}i=0;while(i<this.length){ch=this.charCodeAt(i);hash=(hash<<5)-hash+ch|0;i++}return hash};this.CanvasRenderingContext2D.prototype.pathRect=function(x,y,w,h){this.moveTo(x,y);this.lineTo(x+w,y);this.lineTo(x+w,y+h);this.lineTo(x,y+h);this.closePath()};this.Copyable=function(){};this.Copyable.detect=function(ob){return!!ob.copy&&typeof ob.copy==="function"};_copy=function(obj,deep,seen,copies){var key,loc,ret;ret=void 0;loc=void 0;key=void 0;if("object"!==typeof obj||obj===null){return obj}if(deep&&(loc=indexOf(seen,obj))>=0){return copies[loc]}if(typeof obj==="array"){ret=obj.slice();if(deep){loc=ret.length;while(--loc>=0){ret[loc]=_copy(ret[loc],deep,seen,copies)}}}else if(Copyable&&Copyable.detect(obj)){ret=obj.copy(deep,seen,copies)}else if(obj instanceof Date){ret=new Date(obj.getTime())}else{ret={};for(key in obj){if(!obj.hasOwnProperty(key)){continue}if(key.substring(0,2)==="__"){continue}ret[key]=deep?_copy(obj[key],deep,seen,copies):obj[key]}}if(deep){seen.push(obj);copies.push(ret)}return ret};this.copy=function(obj,deep){if("object"!==typeof obj||obj===null){return obj}if(Copyable&&Copyable.detect(obj)){return obj.copy(deep)}return _copy(obj,deep,deep?[]:null,deep?[]:null)};this.lcgrng=function(v){return imul(v,22695477)+1|0};this.Promise=window.Promise||ES6Promise.Promise;if(!Promise){throw new Error("shiver.js will not work. Your browser is an obstacle to progress and needs to have the es6 Promise polyfills ( https://github.com/jakearchibald/es6-promise ) included in the page, or be destroyed.")}this.awaitTime=function(milliseconds){return new Promise(function(g,b){return setTimeout(g,milliseconds)})};this.awaitRequest=function(httpType,address,data,contentType){return new Promise(function(g,b){var q;q=new XMLHttpRequest;q.open(httpType,address,true);if(contentType){q.setRequestHeader("Content-Type",contentType)}q.onreadystatechange=function(ev){var e,o;if(q.readyState===4){if(q.status===200){o=void 0;try{o=JSON.parse(q.responseText)}catch(_error){e=_error;b("json malformed. wtf, server?");return}g(o)}else{b("problem fetching json. "+q.status+".")}}};q.ontimeout=function(ev){b("ajax query took too long. Network problem?")};return q.send(data||null)})};this.postJsonGetJson=function(address,data){return awaitRequest("POST",address,JSON.stringify(data),"application/json")};this.postDataGetJson=function(address,data){return awaitRequest("POST",address,data)};this.fetchJson=function(address){return awaitRequest("GET",address,null)};this.getConnectedShivSock=function(address,callback){return new Promise(function(g,b){var WS,ws;WS=WebSocket||MozWebSocket;ws=new WS(address);ws.onopen=function(){return g(new ShivSock(ws))};return ws.onerror=function(e){return b(e)}})};defaultSock=null;this.ShivSock=function(){var wsDividerString;function ShivSock(ws,defaultEntity){var self;this.ws=ws;this.incoming=__bind(this.incoming,this);if(!defaultSock){defaultSock=this}this.entities=defaultEntity?{"":defaultEntity}:{};this.batch=[];self=this;this.ws.onclose=function(msgo){console.error("the websocket connection was broken. ("+msgo+").")};this.ws.onmessage=this.incoming;window.addEventListener("beforeunload",function(_this){return function(e){if(_this.ws){_this.ws.close(1e3,"page closed");return _this.ws=null}}}(this))}wsDividerString="←≑→";ShivSock.prototype.ws=null;ShivSock.prototype.newId=1;ShivSock.prototype.batch=null;ShivSock.prototype.batchingLatency=0;ShivSock.prototype.batchingIntervalID=0;ShivSock.prototype.hangingOutFor=null;ShivSock.prototype.tryingToSuffice=0;ShivSock.prototype.entities=null;ShivSock.prototype.defaultTimeout=6e3;ShivSock.prototype.registerEntity=function(entity){if(entity.name.indexOf(wsDividerString)>=0){throw new Error("why the hell are you trying to coin an address that has the divider string in it.")}else if(this.entities[entity.name]){throw new Error("entity already registered")}else{this.entities[entity.name]=entity}};ShivSock.prototype.processIncomingObject=function(msg){var o,re,to;to=msg.to||"";re=this.entities[to];if(re){return re.processIncomingObject(msg)}else{console.warning("message to entity that doesn't exist");o={no:"this entity does not exist"};if(msg.rq){o.rp=msg.rq}return this.transmit(addAddresses(o,msg.from,msg.to))}};ShivSock.prototype.incoming=function(msgo){var e,msg,o,_i,_len;msg=void 0;try{msg=JSON.parse(msgo.data)}catch(_error){e=_error;console.error("server just sent me a packet that wasn't JSON. I don't understand "+msgo);return}if(msg.constructor===Array){for(_i=0,_len=msg.length;_i<_len;_i++){o=msg[_i];this.processIncomingObject(o)}}else{this.processIncomingObject(msg)}};ShivSock.prototype.batchPump=function(){if(this.batch.length>0){if(this.batch.length===1){this.actuallyTransmit(this.batch[0])}else{this.actuallyTransmit(this.batch)}this.batch=[]}};ShivSock.prototype.setBatchingLatency=function(milliseconds){var self;if(this.batchingLatency!==0){clearInterval(this.batchingIntervalID);if(milliseconds===0){this.batchPump()}}this.batchingLatency=milliseconds;if(milliseconds!==0){self=this;this.batchingIntervalID=setInterval(function(){self.batchPump()},milliseconds)}};ShivSock.prototype.enableBatching=function(){this.setBatchingLatency(10)};ShivSock.prototype.disableBatching=function(){this.setBatchingLatency(0)};ShivSock.prototype.actuallyTransmit=function(msg){this.ws.send(JSON.stringify(msg))};ShivSock.prototype.transmit=function(msg){if(this.batchingLatency>0){this.batch.push(msg)}else{this.actuallyTransmit(msg)}};ShivSock.prototype.newEntity=function(cob){var sen;sen=new ShivEntity(cob.name,this);this.registerEntity(sen);if(cob.onMessage){sen.onMessage=cob.onMessage}if(cob.onQuery){sen.onQuery=cob.onQuery}return sen};return ShivSock}();this.ShivEntity=function(){var addAddresses;ShivEntity.prototype.newId=1;ShivEntity.prototype.hangingOutFor=null;ShivEntity.prototype.tryingToSuffice=null;ShivEntity.prototype.recieptListeners=null;ShivEntity.prototype.requestListeners=null;ShivEntity.prototype.name=null;function ShivEntity(name){this.name=name;this.hangingOutFor={};this.recieptListeners=[];this.requestListeners=[];this.tryingToSuffice={}}addAddresses=function(o,to,from){if(to&&to.length>0){o.to=to}if(from&&from.length>0){o.from=from}return o};ShivEntity.prototype.query=function(o,to,through){if(through==null){through=defaultSock}return new Promise(function(_this){return function(g,b){_this.hangingOutFor[_this.newId]={g:g,b:b};through.transmit(addAddresses({o:o,rq:_this.newId},to,_this.name));return _this.newId+=1}}(this))};ShivEntity.prototype.issue=function(o,to,through){if(through==null){through=defaultSock}return through.transmit(addAddresses({o:o},to,this.name))};ShivEntity.prototype.processIncomingObject=function(msg,socket){var fo,responseId,sende,sendo,waiting;if(msg.rq){responseId=msg.rq;++this.tryingToSuffice;fo=this.onQuery(msg.o,msg.from);if(fo===null){throw Error("onQuery handler must return a Promise")}sendo=function(outgoing){this.socket.transmit(JSON.stringify(addAddresses({rp:responseId,o:outgoing},msg.from,msg.to)));return--this.tryingToSuffice};sende=function(erreason){this.socket.transmit(JSON.stringify(addAddresses({rp:responseId,no:erreason},msg.from,msg.to)));return--this.tryingToSuffice};if(fo.constructor===Promise){fo.then(sendo,sende)}else{sendo(fo)}}else if(msg.rp){waiting=this.hangingOutFor[msg.rp];if(waiting){delete this.hangingOutFor[msg.rp];if(msg.no){waiting.b(msg.no)}else if(msg.o){waiting.g(msg.o)}else{console.error("this message doesn't seem to obey the shivsock protocol; "+JSON.stringify(msg))}}else{console.error("server sent a response we didn't ask for, "+JSON.stringify(msg))}}else{this.onMessage(msg.o)}};ShivEntity.prototype.onQuery=function(msg,from){};ShivEntity.prototype.onMessage=function(msg,from){};return ShivEntity}()}).call(this);